<!DOCTYPE html>
<html>
<head>
    <title>Print</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                
                var viewport = undefined;
Ext.define('PrintApp', {
    extend: 'Rally.app.App',
    componentCls: 'app',
    theStore: undefined, // app level references to the store and grid for easy access in various methods
    theGrid: undefined,
    viewport: undefined,
    theFetch: ['FormattedID',
        'Name',
        'Project',
        'Owner',
        'Size',
        'DisplayColor',
        'State',
        'PreliminaryEstimate',
        'Parent',
        'ActualStartDate',
        'ActualEndDate',
        'PlannedStartDate',
        'PlannedEndDate',
        'c_QRWP',
        'PortfolioItemType',
        'c_OrderBookNumberOBN'
    ],





    /*
    items: [ // pre-define the general layout of the app; the skeleton (ie. header, content, footer)
        {
            xtype: 'container', // this container lets us control the layout of the pulldowns; they'll be added below
            itemId: 'pulldown-container',
            margin: '5 5 5 5',
            layout: {
                type: 'hbox', // 'horizontal' layout
                align: 'stretch'
            }
        }, {
            xtype: 'container', // this container lets us control the layout of the pulldowns; they'll be added below
            itemId: 'display-container',
            margin: '5 5 5 5',
            html: 'loading',
            layout: {
                type: 'hbox', // 'horizontal' layout
                align: 'stretch'
            }
        }
    ],
    */
    launch: function () {
        var me = this;
        me._createLayout();
    },

    _createLayout: function () {
        console.log('f _createLayout');
        var me = this;
        var x = 0;
        var viewport = Ext.create('Ext.container.Viewport', {
            extend: 'Ext.app.Controller',
            layout: 'border',
            items: [{
                region: 'north',
                xtype: 'panel',
                itemId: 'north',
                id: 'viewPortnorth',
                height: 40,
                minHeight: 40,
                html: 'north',
            }, {
                region: 'south',
                xtype: 'panel',
                itemId: 'south',
                id: 'viewPortSouth',
                height: 120,
                minHeight: 120,
                html: 'South',
            }, {
                region: 'center',
                xtype: 'panel',
                itemId: 'center',
                id: 'viewPortCenter',
                html: 'Center',
            }],
            listeners: {
                beforerender: function () {
                    // Triggers before the parent viewport loads
                    console.log('Viewport Loading');
                },
                afterrender: function () {
                    // Triggers after the viewport & all of its panels have loaded
                    console.log('Viewport Rendered');
                    //me._addFetchType();
                },
                add: function () {
                    // Counts in our viewports regions as they load
                    x++;
                    console.log('Viewport Rendering [ #', x, ']');
                },
                scope: me
            },
        });
        this.add(viewport);
        x = null;
        console.log('finished', viewport);
        viewport.getComponent('#north').add('aaaaa');
    },

    _addFetchType: function () {
        console.log('finished', this.viewport);
        console.log('fetching');
        var me = this;
        var iterComboBox = Ext.create('Rally.ui.combobox.PortfolioItemTypeComboBox', {
            itemId: 'portfolio-combobox', // we'll use this item ID later to get the users' selection
            fieldLabel: 'Select',
            labelAlign: 'left',
            width: 300,
            listeners: {
                ready: function () {
                    //   me._loadData(1); // initialization flow: next, load severities
                    //console.log(' Ready ', iterComboBox);
                },
                select: function () {
                    //me._loadData(2); // user interactivity: when they choose a value, (re)load the data
                    // console.log(' Change ', iterComboBox);
                },
                scope: me
            },
        });
        //console.log(me.viewport);
        //me.viewport.add(iterComboBox);
        me.down('north').add('d'); // add the iteration list to the pulldown container so it lays out horiz, not the app!
    },



    _getFilters: function (value) {
        var theFilter = Ext.create('Rally.data.wsapi.Filter', {
            property: 'PortfolioItemType',
            operation: '=',
            value: value
        });
        return theFilter;
    },
    _loadData: function (myX) {
        var me = this;
        var selectedItem = this.down('#portfolio-combobox').getRecord().get('_ref'); // the _ref is unique, unlike the iteration name that can change; lets query on it instead!
        var myFilter = this._getFilters(selectedItem);
        // if store exists, just load new data
        if (me.theStore) {
            me.theStore.setFilter(myFilter);
            me.theStore.load();
            // create store
        } else {
            me.theStore = Ext.create('Rally.data.wsapi.Store', { // create theStore on the App (via this) so the code above can test for it's existence!
                model: 'PortfolioItem',
                autoLoad: true, // <----- Don't forget to set this to true! heh
                filters: myFilter,
                type: 'PortfolioItem',
                listeners: {
                    load: function (myStore, myData, success) {
                        if (!me.theGrid) { // only create a grid if it does NOT already exist
                            //me._createGrid(myData); // if we did NOT pass scope:this below, this line would be incorrectly trying to call _createGrid() on the store which does not exist.
                        }
                    },
                    scope: me // This tells the wsapi data store to forward pass along the app-level context into ALL listener functions
                },
                fetch: this.theFetch // Look in the WSAPI docs online to see all fields available!
            });
        }
    },

});

            Rally.launchApp('PrintApp', {
                name:"Print",
	            parentRepos:""
            });

        });
    </script>



    <style type="text/css">
        .app {
  /* Add app styles here */
}

    </style>
</head>
<body>
</body>
</html>
