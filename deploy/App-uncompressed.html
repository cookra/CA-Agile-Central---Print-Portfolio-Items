<!DOCTYPE html>
<html>
<head>
    <title>Print</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define('MySharedData', {
    singleton: true,
    printHtml: '',
    supportArray: [],
    // Needs automating!
    portfolioType: [
        'PortfolioItem/BUStrategicObjectives',
        'PortfolioItem/STPortfolioObjectives',
        'PortfolioItem/PortfolioEpic',
        'PortfolioItem/BusinessOutcome',
        'PortfolioItem/Feature',
    ], // Portfolio Types
});

Ext.define('PrintApp', {
    extend: 'Rally.app.App',
    theStore: undefined, // app level references to the store and grid for easy access in various methods
    printHtml: null,
    theFetch: ['FormattedID',
        'Name',
        'Project',
        'Owner',
        'Size',
        'DisplayColor',
        'State',
        'PreliminaryEstimate',
        'Parent',
        'Release',
        'c_QRWP',
        '_type',
        'PortfolioItemType',
        '_refObjectName',
        'c_OrderBookNumberOBN'
    ],
    launch: function () {
        console.log('\033[2J');
        var me = this;
        var xData1 = this.getContext().getUser();
        var xData2 = this.getContext().getProject();
        var xData3 = this.getContext().getWorkspace();
        var xData4 = this.getContext().getSubscription();
        var gEpros = App.Emailer; // shorten global property string
        var layout = Ext.create('Ext.container.Container', {
            layout: 'fit',
            align: 'stretch',
            height: '100%',
            layoutConfig: {
                align: 'stretch',
            },
            items: [{
                xtype: 'panel',
                border: false,
                layout: 'hbox',
                html: '',
                id: 'myHeader',
                itemId: 'header',
                listeners: {
                    add: function () {
                        console.log('@ Launch Added Panel');
                    },
                    scope: me
                },
                items: [{
                        xtype: 'rallyusersearchcombobox',
                        storeConfig: {
                            model: 'PortfolioItem'
                        },
                        fieldLabel: 'Filter by Owner:',
                        project: this.getContext().getProject(),
                        //value: Rally.util.Ref.getRelativeUri(this.getContext().getUser()),
                        itemId: 'user-combobox', // we'll use this item ID later to get the users' selection
                        //labelAlign: 'right',
                        id: 'user-combobox',
                        // multiSelect: true, // <------------explore this
                        margin: '5 5 5 5',
                        //emptyText: 'All Users',
                        noEntryText: '-- All --',
                        //noEntryValue: 'All',
                        defaultSelectionPosition: 'first',
                        listeners: {
                            select: function () {
                                console.log('@ Launch User Selected [ User ]');
                                me._kickoff('User');
                            },
                            scope: me
                        }
                    }, {
                        xtype: 'rallyportfolioitemtypecombobox',
                        itemId: 'portfolio-combobox', // we'll use this item ID later to get the users' selection
                        fieldLabel: 'Select',
                        labelAlign: 'left',
                        id: 'portfolio-combobox',
                        margin: '5 5 5 5',
                        listeners: {
                            select: function () {
                                console.log('@ Launch User Selected [ Item ]');
                                me._kickoff('User');
                            },
                            scope: me
                        }
                    }, {
                        xtype: 'rallysearchcombobox',
                        storeConfig: {
                            model: 'PortfolioItem'
                        },
                        itemId: 'search-combobox', // we'll use this item ID later to get the users' selection
                        fieldLabel: 'Search',
                        labelAlign: 'right',
                        id: 'search-combobox',
                        width: 300,
                        margin: '5 5 5 5',
                        listeners: {
                            specialkey: function (field, e) {
                                if (e.getKey() === e.ENTER) {
                                    console.log('@ Launch User Pressed [ Enter ]');
                                    me._kickoff('Search');
                                }
                            },
                            select: function () {
                                console.log('@ Launch User Selected [ Search Value ]');
                                me._kickoff('Search');
                            },
                            scope: me
                        }
                    },
                    {
                        xtype: 'button',
                        text: 'Print Results',
                        margin: '5 5 5 20',
                        handler: this._getPrint,
                        listeners: {
                            add: function () {
                                console.log('@ Launch Added Print Button');
                            },
                            scope: me
                        }
                    },
                    {
                        xtype: 'button',
                        text: 'Support',
                        margin: '5 5 5 20',
                        listeners: {
                            afterrender: function (v) {
                                v.el.on('click', function () {
                                    var email = new gEpros._emailer(MySharedData.supportArray, xData1, xData2, xData3, xData4);
                                    console.log('@ Launch Added Support Button');
                                });
                            },
                            scope: me
                        }
                    }
                ],
            }, {
                xtype: 'container',
                layout: 'fit',
                align: 'stretch',
                height: '100%',
                layoutConfig: {
                    align: 'stretch',
                },
                items: [{
                    xtype: 'box',
                    id: 'myInfoPanel',
                    autoScroll: true,
                    margin: '10 5 5 10',
                    height: 40,
                    width: '100%',
                    style: {
                        background: '#ff6600',
                        border: '1px solid',
                    },
                    autoEl: {
                        tag: 'div',
                        cls: 'myInfoPanel',
                        html: '',
                    },
                    listeners: {
                        add: function () {
                            console.log('@ Launch Added Content Box');
                        },
                        scope: me
                    },
                    flex: 1,
                }, {
                    xtype: 'box',
                    id: 'myTarget',
                    autoScroll: true,
                    margin: '10 5 5 10',
                    width: '100%',
                    style: {
                        borderTop: '1'
                    },
                    autoEl: {
                        tag: 'div',
                        cls: 'myContent',
                        html: '',
                    },
                    listeners: {
                        add: function () {
                            console.log('@ Launch Added Content Box');
                        },
                        scope: me
                    },
                    flex: 1



                }]

            }, ]
        });
        this.add(layout);
    },
    _kickoff: function (type) {
        this._loadData(type);
        console.log('@ _kickoff going to _loadData');
    },
    _getFilters: function (t) {
        var theFilter, p, pp, pc, folioFilter, userFilter;
        if (t === 'Search') {
            p = Ext.getCmp('search-combobox').getRecord().get('Name');
            theFilter = Ext.create('Rally.data.wsapi.Filter', {
                property: 'Name',
                operation: '=',
                value: p,
            });
        }
        if (t === 'User') {
            if (this.down('rallyusersearchcombobox').getValue() === null) {
                p = this.down('rallyportfolioitemtypecombobox');
                folioFilter = Ext.create('Rally.data.wsapi.Filter', {
                    property: 'PortfolioItemType',
                    operation: '=',
                    value: p.getValue(),
                });
                theFilter = folioFilter;
            } else {
                p = this.down('rallyportfolioitemtypecombobox');
                folioFilter = Ext.create('Rally.data.wsapi.Filter', {
                    property: 'PortfolioItemType',
                    operation: '=',
                    value: p.getValue(),
                });
                pp = this.down('rallyusersearchcombobox');
                userFilter = Ext.create('Rally.data.wsapi.Filter', {
                    property: 'owner',
                    value: pp.getValue(),
                });
                theFilter = folioFilter.and(userFilter);
            }
        }
        console.log('@ _getFilters Search [', t, ']');
        p = undefined;
        pp = undefined;
        return theFilter;
    },
    _loadData: function (type) {
        //console.log('@ _loadData working the store magic..');
        this._mask("Going deep, searching...");
        var me = this;
        var myFilter = this._getFilters(type);
        //console.log('@ _loadData Exposed Filter [', myFilter, ']');
        if (me.theStore) {
            me.theStore.setFilter(myFilter);
            me.theStore.load();
            //console.log('@ _loadData We have been here already, using load() to fetch new data');
        } else {
            me.theStore = Ext.create('Rally.data.wsapi.Store', { // create theStore on the App (via this) so the code above can test for it's existence!
                model: 'PortfolioItem',
                autoLoad: true, // <----- Don't forget to set this to true! heh
                filters: myFilter,
                limit: Infinity,
                type: 'PortfolioItem',
                listeners: {
                    load: function (myStore, myData) {
                        me._createResults(myData); // if we did NOT pass scope:this below, this line would be incorrectly trying to call _createGrid() on the store which does not exist.
                        //   console.log('@ _loadData load() fired going to _createResults ', myData);

                        Ext.fly('myInfoPanel').update(Ext.create('App.Info')._build('header','the test string'));
                    },
                    scope: me // This tells the wsapi data store to forward pass along the app-level context into ALL listener functions
                },
                fetch: this.theFetch // Look in the WSAPI docs online to see all fields available!
            });
            //console.log('@ _loadData New store request');

        }
    },
    _createResults: function (myData) {
        //console.log('@ _createResults Building HTML based on [myData] passed by the store');
        MySharedData.supportArray = myData;
        var html = '<div id="cards">';
        for (var x = 0; x < myData.length; x++) {
            html += Ext.create('App.Card')._build(x, myData.length, myData[x], this.theType);
        }
        html += '</div>';
        Ext.fly('myTarget').update(html);
        this._unmask();
        MySharedData.printHtml = html;
    },
    _getPrint: function () {
        //console.log('@ _getPrint Print requested');
        var printHtml = null;
        printHtml += Ext.create('App.Card')._print(MySharedData.printHtml);
        return printHtml;
    },
    _mask: function (message) {
        //console.log('@ _mask We are loading the store, show the spinner');
        //this.logger.log("Mask: ", message);
        if (this.sparkler) {
            this.sparkler.destroy();
        }
        this.sparkler = new Ext.LoadMask(this, {
            msg: message
        });
        this.sparkler.show();
        //Ext.fly('myTarget').update(this.sparkler.show());
    },
    _unmask: function () {
        //console.log('@ _unmask We have the data so destroy the spinner');
        if (this.sparkler) {
            this.sparkler.hide();
        }
    },
});
                Ext.define('App.Runtime', {
    singleton: true,
    config: {
        // Versioning
        Pversion: 'v3.0b',
        PappID: 'AC Print Portfolio Items',
        Powner: 'Richard Cook',
        PreleaseDate: '2017-03-06 : 14:38',
        Pdescription: 'Print Portfolio Items',
        // Git Repo Details
        PrepoAddress: 'not shared',
        // Emailer Contact Details
        //

    },
    constructor: function (config) {
        console.log('Runtime Class Saying Hi! - I hold details about this App - Version, Owner, ID etc..');
        var me = this;
        me.initConfig(config);
    },
});
                Ext.define('App.Card', {
    theMarkup: null,
    debugShow: false,
    _build: function (cardNum, totalCards, data) {
        this._showDebug('===== @Card Happy Birthday!');
        this._showDebug('@Card Class Saying Hi! - I build the output HTML for displaying and printing');
        this._showDebug('=====');
        var myRelease, myQRWP, myOBN, myColour, myNode, myParentID, myParentIDName, myEstimate, myName, myOwner, myId;


        // @Scenario 1: Strategic Objective ######################################################################
        // No OBN
        // No Release
        // No Parent
        // No QRWP
        // @Scenario 2: Portfolio Objective ######################################################################
        // No OBN
        // No Release
        // No QRWP
        // @Scenario 2: Portfolio Epic
        // MUST HAVE OBN !!! (Cost Allocation) ######################################################################
        // No Release
        // No QRWP
        // @Scenario 3: Business Outcome ######################################################################
        // No OBN
        // @Scenario 4: Feature
        // No OBN



        //========================================================================================================================================================================
        //
        // OBN
        //
        if (data.raw.c_OrderBookNumberOBN) {
            this._showDebug('@Card Filter [ OBN ] > (found) sending to _shortenString ', data.raw.c_OrderBookNumberOBN);
            myOBN = this._shortenString(data.raw.c_OrderBookNumberOBN, 50, data.raw._type, 'OBN');
        } else {
            this._showDebug('@Card Filter [ OBN ] > (not found) checking if needed with this item _checkMissing ');
            myOBN = this._checkMissing(data.raw._type, 'OBN');
        }
        //========================================================================================================================================================================
        //
        // COLOUR
        //
        if (data.raw.DisplayColor) {
            this._showDebug('@Card Filter [ Colour ] > (found) ', data.raw.DisplayColor);
            myColour = data.raw.DisplayColor;
        } else {
            this._showDebug('@Card Filter [ Colour ] > (not found) NOT POSSIBLE!!! Colour set to #ff6600');
            this._showDebug('=====');
            myColour = "#ff6600";
        }
        //========================================================================================================================================================================
        //
        // PROJECT
        //
        if (data.raw.Project) {
            this._showDebug('@Card Filter [ Project ] > (found) sending to _shortenString ', data.raw.Project.Name);
            myNode = this._shortenString(data.raw.Project.Name, 30, data.raw._type, 'Project');
        } else {
            this._showDebug('@Card Filter [ Project ] > (not found) NOT POSSIBLE!!! No Node Assigned');
            myNode = "No Node Assigned";
        }
        //========================================================================================================================================================================
        //
        // RELEASE
        //
        if (data.raw.Release === undefined || !data.raw.Release) {
            this._showDebug('@Card Filter [ Release ] > (not found) cheking if needed with this item _checkMissing');
            myRelease = this._checkMissing(data.raw._type, 'Release');
        } else {
            this._showDebug('@Card Filter [ Release ] > (found) sending to _shortenString ', data.raw.Release);
            myRelease = this._shortenString(data.raw.Release.Name, 25, data.raw._type, 'Release');
        }
        //========================================================================================================================================================================
        //
        // QRWP
        //
        if (data.raw.c_QRWP === undefined || !data.raw.c_QRWP) {
            this._showDebug('@Card Filter [ QRWP ] > (not found) cheking if needed with this item _checkMissing');
            myQRWP = this._checkMissing(data.raw._type, 'QRWP');
        } else {
            this._showDebug('@Card Filter [ QRWP ] > (found) sending to _shortenString ', data.raw.c_QRWP);
            myQRWP = this._shortenString(data.raw.c_QRWP, 26, data.raw._type, 'QRWP');
        }
        //========================================================================================================================================================================
        //
        // PARENT
        //
        if (data.raw.Parent) {
            this._showDebug('@Card Filter [ Parent ] > (found) sending to _shortenString ', data.raw.Parent.FormattedID, ' ', data.raw.Parent.Name);
            myParentID = 'Parent: ' + data.raw.Parent.FormattedID;
            myParentIDName = this._shortenString(data.raw.Parent.Name, 50, data.raw._type, 'Parent');
        } else {
            this._showDebug('@Card Filter [ Parent ] > (not found) sending to _checkMissing');
            myParentIDName = "";
            myParentID = this._checkMissing(data.raw._type, 'Parent');
        }
        //========================================================================================================================================================================
        //
        // ESTIMATE
        //
        if (data.raw.PreliminaryEstimate) {
            this._showDebug('@Card Filter [ Estimate ] > (found) A sending to _shortenString ', data.raw.PreliminaryEstimate.Name);
            myEstimate = data.raw.PreliminaryEstimate.Name;
        } else if (data.raw.PlanEstimate) {
            this._showDebug('@Card Filter [ Estimate ] > (found) B sending to _shortenString ', data.raw.PreliminaryEstimate.Name);
            myEstimate = data.raw.PlanEstimate;
        } else if (data.raw.Estimate) {
            this._showDebug('@Card Filter [ Estimate ] > (found) C sending to _shortenString ', data.raw.PreliminaryEstimate.Name);
            myEstimate = data.raw.Estimate;
        } else {
            this._showDebug('@Card Filter [ Estimate ] > (Not Found) Not Sized');
            this._showDebug('=====');
            myEstimate = "Not Sized";
        }
        //========================================================================================================================================================================
        //
        // NAME
        //
        if (data.raw._refObjectName) {
            this._showDebug('@Card Filter [ Name ] > (found) sending to _shortenString ', data.raw._refObjectName);
            myName = this._shortenString(data.raw._refObjectName, 135, data.raw._type, 'Name');
        } else {
            this._showDebug('@Card Filter [ Name ] > (Not Found) NOT POSSIBLE!!! No Name');
            myName = 'No Name';

        }
        //========================================================================================================================================================================
        //
        // OWNER
        //
        if (data.raw.Owner) {
            this._showDebug('@Card Filter [ Owner ] > (found) sending to _shortenString ', data.raw.Owner._refObjectName);
            myOwner = this._shortenString(data.raw.Owner._refObjectName, 50, data.raw._type, 'Owner');
        } else {
            this._showDebug('@Card Filter [ Owner ] > (Not Found) No Owner');
            myOwner = 'No Owner';

        }
        myId = data.raw.FormattedID;
        // NASTY HACK FOR ExtJS (Inline CSS builds) //
        var cssStyleTag_Start = ' style="';
        var cssStyleTag_End = '"';
        var cssCropmarks = cssStyleTag_Start + 'border: 2px dashed #cccccc;padding: 10px;position: relative;float: left' + cssStyleTag_End;
        var cssArtifacts = cssStyleTag_Start + 'border: 3px solid #000;width: 260px;white-space: normal;color: black;background-color: #fff;page-break-inside: avoid' + cssStyleTag_End;
        var cssRow_Id = cssStyleTag_Start + 'border-bottom: 1px dashed black;text-align: left;width: 250px;font: bold 20px Genova, sans-serif;padding: 5px;' + cssStyleTag_End;
        var cssRow_Parent = cssStyleTag_Start + 'border-bottom: 1px dashed black;text-align: right;width: 250px;font: bold 12px Genova, sans-serif;padding: 5px;height: 70px;' + cssStyleTag_End;
        var cssRow_Name = cssStyleTag_Start + 'height: 90px;border-bottom: 1px dashed black;text-align: left;width: 250px;font: 15px Genova, sans-serif;padding: 5px;' + cssStyleTag_End;
        var cssRow_Large = cssStyleTag_Start + 'border-bottom: 1px dashed black;text-align: right;width: 250px;font: bold 12px Genova, sans-serif;padding: 5px;height:30px;' + cssStyleTag_End;
        var cssRow_Normal = cssStyleTag_Start + 'border-bottom: 1px dashed black;text-align: right;width: 250px;font: bold 12px Genova, sans-serif;padding: 5px;' + cssStyleTag_End;
        var cssRow_Normal_Last = cssStyleTag_Start + 'text-align: right;width: 250px;font: bold 12px Genova, sans-serif;padding: 5px;' + cssStyleTag_End;
        var cssRow_Colour = cssStyleTag_Start + '!important;border-top: 3px solid black;height: 30px;width: 100%;background:' + data.raw.DisplayColor + cssStyleTag_End;
        var cssClearBoth = cssStyleTag_Start + 'clear:both' + cssStyleTag_End;
        var theMarkup =
            '<div class="crop-marks" ' + cssCropmarks + '>' +
            '<div class="artifact" ' + cssArtifacts + '>' +
            '<div class="row_id" ' + cssRow_Id + '>' + myId + '</div>' +
            '<div class="row_name" ' + cssRow_Name + '><span style="color:#ff6600">Name:</span> ' + myName + '</div>' +
            '<div class="row_parent" ' + cssRow_Parent + '><span style="color:#ff6600">Parent:</span> ' + myParentID + '<br/>' + myParentIDName + '</div>' +
            '<div class="row_normal" ' + cssRow_Large + '><span style="color:#ff6600">Node:</span> ' + myNode + '</div>' +
            '<div class="row_normal" ' + cssRow_Large + '><span style="color:#ff6600">Release:</span> ' + myRelease + '</div>' +
            '<div class="row_normal" ' + cssRow_Normal + '><span style="color:#ff6600">QRWP:</span> ' + myQRWP + '</div>' +
            '<div class="row_normal" ' + cssRow_Normal + '><span style="color:#ff6600">OBN:</span> ' + myOBN + '</div>' +
            '<div class="row_normal_last" ' + cssRow_Normal + '><span style="color:#ff6600">Owner:</span> ' + myOwner + '</div>' +
            '<div class="row_normal" ' + cssRow_Normal_Last + '><span style="color:#ff6600">T-Shirt Size:</span> ' + myEstimate + '</div>' +
            '<div class="row_colour" ' + cssRow_Colour + '>&nbsp;</div>' +
            '</div>' +
            '</div>';
        // Printing Layout Shaper 2 x 2 cards
        if (Math.ceil((cardNum + 1) % 4) === 0) {
            theMarkup = theMarkup + '<div class=pb></div>';
        } else if (cardNum === totalCards - 1) {
            theMarkup = theMarkup + '<div class=cb ' + cssClearBoth + '>&nbsp;</div>';
        }
        this._showDebug('===== @Card Ending !!!');
        return theMarkup;
    },
    _showDebug: function (msg){
        if(this.debugShow===true){
            console.log(msg);
        }
    },
    _print: function (data) {
        var title, options, printWindow, doc;
        title = 'Print Cards';
        options = "toolbar=0,menubar=0,scrollbars=yes,scrolling=yes,resizable=yes,width=1000,height=500";
        printWindow = window.open('', title, options);
        doc = printWindow.document;
        doc.write('<html><head><title>Print Feature</title>');
        doc.write('</head><body class="landscape" style="-webkit-print-color-adjust: exact;">');
        doc.write(data);
        doc.write('</body></html>');
        doc.close();
        printWindow.print();
        this._showDebug('@Card _Print Fired');
        return false;
    },
    // Fits our text into the diaplay panel take the string and the length you want to cut by then adds ... if the string breaches the limit
    _shortenString: function (string, stringLength, type, name) {
        //this._showDebug('_shortenString:', string, stringLength);
        var output, result;
        if (string.length > stringLength) {
            output = string.substring(stringLength, length) + ' ...';
            result = string + '***** [ Trimmed ] *****';
        } else {
            output = string;
        }
        if (string.length <= stringLength) {
            result = '***** [ No Change ] *****';
        }
        //this._showDebug('@Card Filter [', name, '] @ _shortenString', string, ' MaxChar: ', stringLength, ' Result: ', result);
        this._showDebug('=====');
        return output;
    },
    _checkMissing: function (portfolioType, item) {
        var output, f1, f2, f3, f4, f5;
        f1 = MySharedData.portfolioType[0];
        f2 = MySharedData.portfolioType[1];
        f3 = MySharedData.portfolioType[2];
        f4 = MySharedData.portfolioType[3];
        f5 = MySharedData.portfolioType[4];
        // Strategic Objective
        if (portfolioType === f1) {
            if (item === 'OBN') {
                output = 'Portfolio Epic Only';
            }
            if (item === 'Release') {
                output = 'Not Required';
            }
            if (item === 'QRWP') {
                output = 'Not Required';
            }
            if (item === 'Parent') {
                output = 'Top Level';
            }
        }
        // Portfolio Objective
        if (portfolioType === f2) {
            if (item === 'OBN') {
                output = 'Portfolio Epic Only';
            }
            if (item === 'Release') {
                output = 'Not Required';
            }
            if (item === 'QRWP') {
                output = 'Not Required';
            }
            if (item === 'Parent') {
                output = 'Missing';
            }
        }
        //Portfolio Epic
        if (portfolioType === f3) {
            if (item === 'OBN') {
                output = 'Missing';
            }
            if (item === 'Release') {
                output = 'Not Required';
            }
            if (item === 'QRWP') {
                output = 'Not Required';
            }
            if (item === 'Parent') {
                output = 'Missing';
            }
        }
        // Business Outcome
        if (portfolioType === f4) {
            if (item === 'OBN') {
                output = 'Portfolio Epic Only';
            }
            if (item === 'Release') {
                output = 'Not Assigned';
            }
            if (item === 'QRWP') {
                output = 'Missing';
            }
            if (item === 'Parent') {
                output = 'Missing';
            }
        }
        // Feature
        if (portfolioType === f5) {
            if (item === 'OBN') {
                output = 'Portfolio Epic Only';
            }
            if (item === 'Release') {
                output = 'Not Assigned';
            }
            if (item === 'QRWP') {
                output = 'Not Required';
            }
            if (item === 'Parent') {
                output = 'Missing';
            }
        }
        //this._showDebug('@Card Filter [', item, '] < @ _checkMissing Type: ', portfolioType, ' Filter Output: ', output);
        this._showDebug('=====');
        return output;
    }
});
                Ext.define('App.Info', {
    theMarkup: null,
    debugShow: false,
    _build: function (style,text) {
        this._showDebug('===== @Info Happy Birthday!');
        this._showDebug('@Info Class Saying Hi! - I build the output HTML for displaying the info bar');
        this._showDebug('=====');
        var output;
        if(style==='header'){

            output = '<h1>'+text+'</h1>';

        }
        return output;
    }});
    
                Ext.define('App.Version', {
    constructor: function () {
        console.log('Version Class Saying Hi! - I output the Ext JS version');
        var theVersion = Ext.getVersion().version;
        return theVersion;
    }
});
                Ext.define('App.Emailer', {
    singleton: true,
    constructor: function () {
        console.log('Config added: c Email');
    },
    _emailer: function (coreData, xData1, xData2, xData3, xData4) {
        console.log('@ _emailer');
        var gProp = App.Runtime;
        var PcontactSubject = 'REF: AC APP ';
        var PcontactMessage = '=========== Please leave your message above this line ==========';
        var PcontactEmail = 'richard.cook@barclaycard.co.uk';
        // User Vars
        var yourapp = '> Browser Web App Name > ' + navigator.appName;
        var yourappalt = '> Browser User Agent > ' + navigator.userAgent;
        var yourversion = '> Browser Version > ' + navigator.appVersion;
        var yourappcodename = '> Browser Code Name > ' + navigator.appCodeName;
        var yourplatform = '> Platform > ' + navigator.platform;
        var youroscpu = '> OS CPU > ' + navigator.oscpu;
        var yourcookie = '> Cookie Enabled > ' + navigator.cookieEnabled;
        var outwinw = '> Owidth > ' + window.outerWidth;
        var outwinh = '> Oheight > ' + window.outerHeight;
        var inwinw = '> Iwidth > ' + window.innerWidth;
        var inwinh = '> Iheight > ' + window.innerHeight;
        var uri = '> Base URI > ' + document.getElementsByTagName('script')[0].baseURI;
        var src = '> SRC > ' + document.getElementsByTagName('script')[0].src;
        var localname = '> LocalName > ' + document.getElementsByTagName('script')[0].localName;
        var type = '> Type > ' + document.getElementsByTagName('script')[0].type;
        var userData = [
            yourapp,
            yourappalt,
            yourversion,
            yourappcodename,
            yourplatform,
            youroscpu,
            yourcookie,
            outwinw,
            outwinh,
            inwinw,
            inwinh,
            uri,
            src,
            localname,
            type
        ];
        // Tools
        var charReturn = '\r\n';
        // Emailer
        var subject = PcontactSubject + ' [ App : ' + gProp.PappID + ' ] : [ version : ' + gProp.Pversion + ' ]';
        var message = PcontactMessage;
        var report = '';

        report += charReturn + charReturn;
        report += 'Environment Report > ' + charReturn;
        report += '> Sencha ExtJS Version > ' + Ext.getVersion().version + charReturn + charReturn;
        report += 'Agile Central Report > ' + charReturn;
        report += '> AC User Username > ' + xData1.UserName+ charReturn;
        report += '> AC User Name > ' + xData1._refObjectName+ charReturn;
        report += '> AC User UUID > ' + xData1._refObjectUUID+ charReturn; 
        report += '> AC User Role > ' + xData1.Role+ charReturn;
        report += '> AC User Loc > ' + xData1._ref+ charReturn;
        report += '> AC User ObjectID > ' + xData1.ObjectID+ charReturn;
        report += '> AC User Default LPage > ' + xData1.LandingPage+ charReturn;
        //report += '> AC User Default Node > ' + xData1.UserProfile.DefaultProject.Name+ charReturn;
        //report += '> AC User Default Workapace > ' + xData1.UserProfile.DefaultWorkspace.Name+ charReturn;
        report += '> AC Application Node > ' + xData2.Name+ charReturn;
        report += '> AC Application Node UUID > ' + xData2._refObjectUUID+ charReturn;
        report += '> AC Application Workspace > ' + xData3.Name+ charReturn;
        report += '> AC Application Workspace UUID > ' + xData3._refObjectUUID+ charReturn;
        report += '> AC Subscription Sub Modules > ' + xData4.Modules+ charReturn;  
        report += '> AC Subscription UUID > ' + xData4._refObjectUUID+ charReturn; 
        report += '> AC Subscription Name > ' + xData4._refObjectName+ charReturn+ charReturn;   

        report += 'Build Details ' + charReturn;
        report += '> ReleaseDate > ' + gProp.PreleaseDate + charReturn;
        report += '> Owner > ' + gProp.Powner + charReturn;
        report += '> Version > ' + gProp.Pversion + charReturn;
        report += '> Description > ' + gProp.Pdescription + charReturn;
        report += '> App ID > ' + gProp.PappID + charReturn + charReturn;

        report += 'Application Report Found ' + coreData.length + ' items' + charReturn;
        for (var i = 0; i < coreData.length; i++) {
            report += '> ' + coreData[i].raw.FormattedID + ' : ';
            report += coreData[i].raw.Name + ' : ';
            report += coreData[i].raw._ref + charReturn;
        }
        report += charReturn;
        report += 'System Report Found ' + userData.length + ' items'+charReturn;
        for (var x = 0; x < userData.length; x++) {
            report += userData[x] + charReturn;
        }
        report = encodeURIComponent(report);      
         console.log('@ _emailer Launch Email App');
        return window.location = 'mailto:' + PcontactEmail + '?subject=' + subject + '&body=' + message + report;
    },
});

            Rally.launchApp('PrintApp', {
                name:"Print",
	            parentRepos:""
            });

        });
    </script>



    <style type="text/css">
        .app {
  /* Add app styles here */
}
@media print {
  body {
    -webkit-print-color-adjust: exact;
  }
  #interface {
    display: none;
  }
  .artifact {
    page-break-inside: avoid;
    /* page-break-before: always; */
    /* clear: both; */
  }
}

    </style>
</head>
<body>
</body>
</html>
