<!DOCTYPE html>
<html>
<head>
    <title>Print</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("MySharedData",{singleton:!0,printHtml:"",supportArray:[],portfolioType:["PortfolioItem/BUStrategicObjectives","PortfolioItem/STPortfolioObjectives","PortfolioItem/PortfolioEpic","PortfolioItem/BusinessOutcome","PortfolioItem/Feature"]}),Ext.define("PrintApp",{extend:"Rally.app.App",theStore:void 0,printHtml:null,theFetch:["FormattedID","Name","Project","Owner","Size","DisplayColor","State","PreliminaryEstimate","Parent","Release","c_QRWP","_type","PortfolioItemType","c_OrderBookNumberOBN"],launch:function(){console.log("[2J");var me=this,xData1=this.getContext().getUser(),xData2=this.getContext().getProject(),xData3=this.getContext().getWorkspace(),xData4=this.getContext().getSubscription(),gEpros=App.Emailer,gRpros=App.Runtime,layout=Ext.create("Ext.container.Container",{layout:"fit",align:"stretch",height:"100%",layoutConfig:{align:"stretch"},items:[{xtype:"panel",width:300,border:!1,layout:"hbox",html:"",id:"myHeader",itemId:"header",listeners:{add:function(){console.log("@ Launch Added Panel")},scope:me},items:[{xtype:"rallyportfolioitemtypecombobox",itemId:"portfolio-combobox",fieldLabel:"Select",labelAlign:"left",id:"portfolio-combobox",width:300,margin:"5 5 5 5",listeners:{select:function(){console.log("@ Launch Added Portfolio Combobox"),me._kickoff()},scope:me}},{xtype:"button",text:"Print Results",margin:"5 5 5 20",handler:this._getPrint,listeners:{add:function(){console.log("@ Launch Added Print Button")},scope:me}},{xtype:"button",text:"Support",margin:"5 5 5 20",listeners:{afterrender:function(v){v.el.on("click",function(){var email=new gEpros._emailer(MySharedData.supportArray,xData1,xData2,xData3,xData4);console.log("@ Launch Added Support Button")})},scope:me}}]},{xtype:"box",id:"myTarget",autoScroll:!0,margin:"10 5 5 10",width:"100%",style:{borderTop:"1"},autoEl:{tag:"div",cls:"myContent",html:""},listeners:{add:function(){console.log("@ Launch Added Content Box")},scope:me},flex:1}]});this.add(layout)},_kickoff:function(){this._loadData(),console.log("@ _kickoff going to _loadData")},_getFilters:function(value){var theFilter=Ext.create("Rally.data.wsapi.Filter",{property:"PortfolioItemType",operation:"=",value:value});return console.log("@ _getFilters returning [",theFilter.property," ",theFilter.operation," ",theFilter.value,"] to _loadData"),theFilter},_loadData:function(){console.log("@ _loadData working the store magic.."),this._mask("Going deep, searching...");var me=this,selectedItem=Ext.getCmp("portfolio-combobox").getRecord().get("_ref"),myFilter=this._getFilters(selectedItem);me.theStore?(me.theStore.setFilter(myFilter),me.theStore.load(),console.log("@ _loadData We have been here already, using load() to fetch new data")):(me.theStore=Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem",autoLoad:!0,filters:myFilter,limit:1/0,type:"PortfolioItem",listeners:{load:function(myStore,myData){me._createResults(myData),console.log("@ _loadData load() fired going to _createResults")},scope:me},fetch:this.theFetch}),console.log("@ _loadData New store request"))},_createResults:function(myData){console.log("@ _createResults Building HTML based on [myData] passed by the store"),MySharedData.supportArray=myData;for(var html='<div id="cards">',x=0;x<myData.length;x++)html+=Ext.create("App.Card")._build(x,myData.length,myData[x],this.theType);html+="</div>",Ext.fly("myTarget").update(html),this._unmask(),MySharedData.printHtml=html},_getPrint:function(){console.log("@ _getPrint Print requested");var printHtml=null;return printHtml+=Ext.create("App.Card")._print(MySharedData.printHtml)},_mask:function(message){console.log("@ _mask We are loading the store, show the spinner"),this.sparkler&&this.sparkler.destroy(),this.sparkler=new Ext.LoadMask(this,{msg:message}),this.sparkler.show()},_unmask:function(){console.log("@ _unmask We have the data so destroy the spinner"),this.sparkler&&this.sparkler.hide()}});
                Ext.define("App.Runtime",{singleton:!0,config:{Pversion:"v2.1b",PappID:"AC Print Portfolio Items",Powner:"Richard Cook",PreleaseDate:"2017-03-02 : 21:34",Pdescription:"Print Portfolio Items",PrepoAddress:"not shared"},constructor:function(config){console.log("Runtime Class Saying Hi! - I hold details about this App - Version, Owner, ID etc..");var me=this;me.initConfig(config)}});
                Ext.define("App.Card",{theMarkup:null,_build:function(cardNum,totalCards,data){console.log("===== @Card Happy Birthday!"),console.log("@Card Class Saying Hi! - I build the output HTML for displaying and printing"),console.log("=====");var myRelease,myQRWP,myOBN,myColour,myNode,myParentID,myParentIDName,myEstimate,myName,myOwner,myId;data.raw.c_OrderBookNumberOBN?(console.log("@Card Filter [ OBN ] > (found) sending to _shortenString ",data.raw.c_OrderBookNumberOBN),myOBN=this._shortenString(data.raw.c_OrderBookNumberOBN,50,data.raw._type,"OBN")):(console.log("@Card Filter [ OBN ] > (not found) checking if needed with this item _checkMissing "),myOBN=this._checkMissing(data.raw._type,"OBN")),data.raw.DisplayColor?(console.log("@Card Filter [ Colour ] > (found) ",data.raw.DisplayColor),myColour=data.raw.DisplayColor):(console.log("@Card Filter [ Colour ] > (not found) NOT POSSIBLE!!! Colour set to #ff6600"),console.log("====="),myColour="#ff6600"),data.raw.Project?(console.log("@Card Filter [ Project ] > (found) sending to _shortenString ",data.raw.Project.Name),myNode=this._shortenString(data.raw.Project.Name,30,data.raw._type,"Project")):(console.log("@Card Filter [ Project ] > (not found) NOT POSSIBLE!!! No Node Assigned"),myNode="No Node Assigned"),void 0!==data.raw.Release&&data.raw.Release?(console.log("@Card Filter [ Release ] > (found) sending to _shortenString ",data.raw.Release),myRelease=this._shortenString(data.raw.Release.Name,25,data.raw._type,"Release")):(console.log("@Card Filter [ Release ] > (not found) cheking if needed with this item _checkMissing"),myRelease=this._checkMissing(data.raw._type,"Release")),void 0!==data.raw.c_QRWP&&data.raw.c_QRWP?(console.log("@Card Filter [ QRWP ] > (found) sending to _shortenString ",data.raw.c_QRWP),myQRWP=this._shortenString(data.raw.c_QRWP,26,data.raw._type,"QRWP")):(console.log("@Card Filter [ QRWP ] > (not found) cheking if needed with this item _checkMissing"),myQRWP=this._checkMissing(data.raw._type,"QRWP")),data.raw.Parent?(console.log("@Card Filter [ Parent ] > (found) sending to _shortenString ",data.raw.Parent.FormattedID," ",data.raw.Parent.Name),myParentID="Parent: "+data.raw.Parent.FormattedID,myParentIDName=this._shortenString(data.raw.Parent.Name,50,data.raw._type,"Parent")):(console.log("@Card Filter [ Parent ] > (not found) sending to _checkMissing"),myParentIDName="",myParentID=this._checkMissing(data.raw._type,"Parent")),data.raw.PreliminaryEstimate?(console.log("@Card Filter [ Estimate ] > (found) A sending to _shortenString ",data.raw.PreliminaryEstimate.Name),myEstimate=data.raw.PreliminaryEstimate.Name):data.raw.PlanEstimate?(console.log("@Card Filter [ Estimate ] > (found) B sending to _shortenString ",data.raw.PreliminaryEstimate.Name),myEstimate=data.raw.PlanEstimate):data.raw.Estimate?(console.log("@Card Filter [ Estimate ] > (found) C sending to _shortenString ",data.raw.PreliminaryEstimate.Name),myEstimate=data.raw.Estimate):(console.log("@Card Filter [ Estimate ] > (Not Found) Not Sized"),console.log("====="),myEstimate="Not Sized"),data.raw._refObjectName?(console.log("@Card Filter [ Name ] > (found) sending to _shortenString ",data.raw._refObjectName),myName=this._shortenString(data.raw._refObjectName,135,data.raw._type,"Name")):(console.log("@Card Filter [ Name ] > (Not Found) NOT POSSIBLE!!! No Name"),myName="No Name"),data.raw.Owner?(console.log("@Card Filter [ Owner ] > (found) sending to _shortenString ",data.raw.Owner._refObjectName),myOwner=this._shortenString(data.raw.Owner._refObjectName,50,data.raw._type,"Owner")):(console.log("@Card Filter [ Owner ] > (Not Found) No Owner"),myOwner="No Owner"),myId=data.raw.FormattedID;var cssStyleTag_Start=' style="',cssStyleTag_End='"',cssCropmarks=cssStyleTag_Start+"border: 2px dashed #cccccc;padding: 10px;position: relative;float: left"+cssStyleTag_End,cssArtifacts=cssStyleTag_Start+"border: 3px solid #000;width: 260px;white-space: normal;color: black;background-color: #fff;page-break-inside: avoid"+cssStyleTag_End,cssRow_Id=cssStyleTag_Start+"border-bottom: 1px dashed black;text-align: left;width: 250px;font: bold 20px Genova, sans-serif;padding: 5px;"+cssStyleTag_End,cssRow_Parent=cssStyleTag_Start+"border-bottom: 1px dashed black;text-align: right;width: 250px;font: bold 12px Genova, sans-serif;padding: 5px;height: 70px;"+cssStyleTag_End,cssRow_Name=cssStyleTag_Start+"height: 90px;border-bottom: 1px dashed black;text-align: left;width: 250px;font: 15px Genova, sans-serif;padding: 5px;"+cssStyleTag_End,cssRow_Large=cssStyleTag_Start+"border-bottom: 1px dashed black;text-align: right;width: 250px;font: bold 12px Genova, sans-serif;padding: 5px;height:30px;"+cssStyleTag_End,cssRow_Normal=cssStyleTag_Start+"border-bottom: 1px dashed black;text-align: right;width: 250px;font: bold 12px Genova, sans-serif;padding: 5px;"+cssStyleTag_End,cssRow_Normal_Last=cssStyleTag_Start+"text-align: right;width: 250px;font: bold 12px Genova, sans-serif;padding: 5px;"+cssStyleTag_End,cssRow_Colour=cssStyleTag_Start+"!important;border-top: 3px solid black;height: 30px;width: 100%;background:"+data.raw.DisplayColor+cssStyleTag_End,cssClearBoth=cssStyleTag_Start+"clear:both"+cssStyleTag_End,theMarkup='<div class="crop-marks" '+cssCropmarks+'><div class="artifact" '+cssArtifacts+'><div class="row_id" '+cssRow_Id+">"+myId+'</div><div class="row_name" '+cssRow_Name+'><span style="color:#ff6600">Name:</span> '+myName+'</div><div class="row_parent" '+cssRow_Parent+'><span style="color:#ff6600">Parent:</span> '+myParentID+"<br/>"+myParentIDName+'</div><div class="row_normal" '+cssRow_Large+'><span style="color:#ff6600">Node:</span> '+myNode+'</div><div class="row_normal" '+cssRow_Large+'><span style="color:#ff6600">Release:</span> '+myRelease+'</div><div class="row_normal" '+cssRow_Normal+'><span style="color:#ff6600">QRWP:</span> '+myQRWP+'</div><div class="row_normal" '+cssRow_Normal+'><span style="color:#ff6600">OBN:</span> '+myOBN+'</div><div class="row_normal_last" '+cssRow_Normal+'><span style="color:#ff6600">Owner:</span> '+myOwner+'</div><div class="row_normal" '+cssRow_Normal_Last+'><span style="color:#ff6600">T-Shirt Size:</span> '+myEstimate+'</div><div class="row_colour" '+cssRow_Colour+">&nbsp;</div></div></div>";return 0===Math.ceil((cardNum+1)%4)?theMarkup+="<div class=pb></div>":cardNum===totalCards-1&&(theMarkup=theMarkup+"<div class=cb "+cssClearBoth+">&nbsp;</div>"),console.log("===== @Card Ending !!!"),theMarkup},_print:function(data){var title,options,printWindow,doc;return title="Print Cards",options="toolbar=0,menubar=0,scrollbars=yes,scrolling=yes,resizable=yes,width=1000,height=500",printWindow=window.open("",title,options),doc=printWindow.document,doc.write("<html><head><title>Print Feature</title>"),doc.write('</head><body class="landscape" style="-webkit-print-color-adjust: exact;">'),doc.write(data),doc.write("</body></html>"),doc.close(),printWindow.print(),console.log("@Card _Print Fired"),!1},_shortenString:function(string,stringLength,type,name){var output,result;return string.length>stringLength?(output=string.substring(stringLength,length)+" ...",result=string+"***** [ Trimmed ] *****"):output=string,string.length<=stringLength&&(result="***** [ No Change ] *****"),console.log("@Card Filter [",name,"] @ _shortenString",string," MaxChar: ",stringLength," Result: ",result),console.log("====="),output},_checkMissing:function(portfolioType,item){var output,f1,f2,f3,f4,f5;return f1=MySharedData.portfolioType[0],f2=MySharedData.portfolioType[1],f3=MySharedData.portfolioType[2],f4=MySharedData.portfolioType[3],f5=MySharedData.portfolioType[4],portfolioType===f1&&("OBN"===item&&(output="Portfolio Epic Only"),"Release"===item&&(output="Not Required"),"QRWP"===item&&(output="Not Required"),"Parent"===item&&(output="Top Level")),portfolioType===f2&&("OBN"===item&&(output="Portfolio Epic Only"),"Release"===item&&(output="Not Required"),"QRWP"===item&&(output="Not Required"),"Parent"===item&&(output="Missing")),portfolioType===f3&&("OBN"===item&&(output="Missing"),"Release"===item&&(output="Not Required"),"QRWP"===item&&(output="Not Required"),"Parent"===item&&(output="Missing")),portfolioType===f4&&("OBN"===item&&(output="Portfolio Epic Only"),"Release"===item&&(output="Not Assigned"),"QRWP"===item&&(output="Not Assigned"),"Parent"===item&&(output="Missing")),portfolioType===f5&&("OBN"===item&&(output="Portfolio Epic Only"),"Release"===item&&(output="Not Assigned"),"QRWP"===item&&(output="Not Assigned"),"Parent"===item&&(output="Missing")),console.log("@Card Filter [",item,"] < @ _checkMissing Type: ",portfolioType," Filter Output: ",output),console.log("====="),output}});
                Ext.define("App.Version",{constructor:function(){console.log("Version Class Saying Hi! - I output the Ext JS version");var theVersion=Ext.getVersion().version;return theVersion}});
                Ext.define("App.Emailer",{singleton:!0,constructor:function(){console.log("Config added: c Email")},_emailer:function(coreData,xData1,xData2,xData3,xData4){console.log("@ _emailer");var gProp=App.Runtime,PcontactSubject="REF: AC APP ",PcontactMessage="=========== Please leave your message above this line ==========",PcontactEmail="richard.cook@barclaycard.co.uk",yourapp="> Browser Web App Name > "+navigator.appName,yourappalt="> Browser User Agent > "+navigator.userAgent,yourversion="> Browser Version > "+navigator.appVersion,yourappcodename="> Browser Code Name > "+navigator.appCodeName,yourplatform="> Platform > "+navigator.platform,youroscpu="> OS CPU > "+navigator.oscpu,yourcookie="> Cookie Enabled > "+navigator.cookieEnabled,outwinw="> Owidth > "+window.outerWidth,outwinh="> Oheight > "+window.outerHeight,inwinw="> Iwidth > "+window.innerWidth,inwinh="> Iheight > "+window.innerHeight,uri="> Base URI > "+document.getElementsByTagName("script")[0].baseURI,src="> SRC > "+document.getElementsByTagName("script")[0].src,localname="> LocalName > "+document.getElementsByTagName("script")[0].localName,type="> Type > "+document.getElementsByTagName("script")[0].type,userData=[yourapp,yourappalt,yourversion,yourappcodename,yourplatform,youroscpu,yourcookie,outwinw,outwinh,inwinw,inwinh,uri,src,localname,type],charReturn="\r\n",subject=PcontactSubject+" [ App : "+gProp.PappID+" ] : [ version : "+gProp.Pversion+" ]",message=PcontactMessage,report="";report+=charReturn+charReturn,report+="Environment Report > "+charReturn,report+="> Sencha ExtJS Version > "+Ext.getVersion().version+charReturn+charReturn,report+="Agile Central Report > "+charReturn,report+="> AC User Username > "+xData1.UserName+charReturn,report+="> AC User Name > "+xData1._refObjectName+charReturn,report+="> AC User UUID > "+xData1._refObjectUUID+charReturn,report+="> AC User Role > "+xData1.Role+charReturn,report+="> AC User Loc > "+xData1._ref+charReturn,report+="> AC User ObjectID > "+xData1.ObjectID+charReturn,report+="> AC User Default LPage > "+xData1.LandingPage+charReturn,report+="> AC Application Node > "+xData2.Name+charReturn,report+="> AC Application Node UUID > "+xData2._refObjectUUID+charReturn,report+="> AC Application Workspace > "+xData3.Name+charReturn,report+="> AC Application Workspace UUID > "+xData3._refObjectUUID+charReturn,report+="> AC Subscription Sub Modules > "+xData4.Modules+charReturn,report+="> AC Subscription UUID > "+xData4._refObjectUUID+charReturn,report+="> AC Subscription Name > "+xData4._refObjectName+charReturn+charReturn,report+="Build Details "+charReturn,report+="> ReleaseDate > "+gProp.PreleaseDate+charReturn,report+="> Owner > "+gProp.Powner+charReturn,report+="> Version > "+gProp.Pversion+charReturn,report+="> Description > "+gProp.Pdescription+charReturn,report+="> App ID > "+gProp.PappID+charReturn+charReturn,report+="Application Report Found "+coreData.length+" items"+charReturn;for(var i=0;i<coreData.length;i++)report+="> "+coreData[i].raw.FormattedID+" : ",report+=coreData[i].raw.Name+" : ",report+=coreData[i].raw._ref+charReturn;report+=charReturn,report+="System Report Found "+userData.length+" items"+charReturn;for(var x=0;x<userData.length;x++)report+=userData[x]+charReturn;return report=encodeURIComponent(report),console.log("@ _emailer Launch Email App"),window.location="mailto:"+PcontactEmail+"?subject="+subject+"&body="+message+report}});

            Rally.launchApp('PrintApp', {
                name:"Print",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        @media print{body{-webkit-print-color-adjust:exact}#interface{display:none}.artifact{page-break-inside:avoid}}
    </style>
</head>
<body>
</body>
</html>
